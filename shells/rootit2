export PATH=DEVICEWORKDIR:$PATH

echo "Cleaning rootit files 1/2"
busybox rm -f DEVICEWORKDIR/rootit
export RCU=$?

if busybox test $RCU -eq 0
then
	echo "Cleaning rootit files 2/2"
	busybox rm -f DEVICEWORKDIR/psneuter
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo "Mounting /system R/W"
	mount -o remount,rw yaffs2 /system >/dev/null 2>&1
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo "Copying Superuser.apk to /system/app"
	export RES=`dd if=DEVICEWORKDIR/Superuser.apk of=/system/app/Superuser.apk`
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo "Copying su to /system/bin"
	dd if=DEVICEWORKDIR/su of=/system/bin/su
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo "Copying busybox to /system/xbin"
	dd if=DEVICEWORKDIR/busybox of=/system/xbin/busybox
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	chown root.root /system/app/Superuser.apk
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	chown root.root /system/bin/su
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	chown root.root /system/xbin/busybox
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	chmod 644 /system/app/Superuser.apk
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	chmod 04755 /system/bin/su
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	chmod 04755 /system/xbin/busybox
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo "#!/system/bin/sh" > /system/etc/install-recovery.sh
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo >> /system/etc/install-recovery.sh
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo "#SD Card Tweak" >> /system/etc/install-recovery.sh
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo "echo 2048 > /sys/devices/virtual/bdi/179:0/read_ahead_kb" >> /system/etc/install-recovery.sh
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	echo "echo 2048 > /sys/devices/virtual/bdi/default/read_ahead_kb" >> /system/etc/install-recovery.sh
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	chmod 04755 /system/etc/install-recovery.sh
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

if busybox test $RCU -eq 0
then
	/system/xbin/busybox --install -s /system/xbin
	export RCU=$?
else
	echo FTError $RES
	exit 31
fi

rm -r DEVICEWORKDIR/*